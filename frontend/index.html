<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Expense Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --primary: #6366f1;
  --bg: #f1f5f9;
  --card: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --success: #16a34a;
  --danger: #dc2626;
}

* { box-sizing: border-box; }

body {
  font-family: Inter, system-ui, sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 24px;
}

h1 { margin-bottom: 24px; }

.card {
  background: var(--card);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}

input, select {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

button {
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  background: var(--primary);
  color: white;
  cursor: pointer;
}

.metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
}

.metric {
  background: linear-gradient(135deg, #eef2ff, #ffffff);
  padding: 16px;
  border-radius: 12px;
  text-align: center;
}

.metric p {
  font-size: 22px;
  font-weight: 600;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 12px;
  border-bottom: 1px solid #e5e7eb;
  text-align: center;
}

tr:hover { background: #f8fafc; }

canvas { max-height: 300px; }

/* ---------- MODAL ---------- */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal {
  background: white;
  padding: 24px;
  border-radius: 14px;
  width: 340px;
}

.modal-details {
  background: #f8fafc;
  padding: 12px;
  border-radius: 8px;
  margin: 14px 0;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.btn-danger { background: var(--danger); }
.btn-secondary { background: #e5e7eb; color: #111; }
</style>
</head>

<body>

<h1>üí∞ Expense Tracker</h1>

<!-- ADD EXPENSE -->
<div class="card">
  <input id="dateInput" type="date" />
  <input id="amountInput" type="number" placeholder="Amount ‚Çπ" />
  <input id="descInput" placeholder="Description" />
  <button onclick="addExpense()">Add Expense</button>
</div>

<!-- METRICS -->
<div class="metrics">
  <div class="metric"><h4>Total</h4><p id="totalText">‚Çπ0</p></div>
  <div class="metric"><h4>This Month</h4><p id="monthText">‚Çπ0</p></div>
  <div class="metric"><h4>Today</h4><p id="todayText">‚Çπ0</p></div>
</div>

<!-- CHARTS -->
<div class="card">
  <h3>üìä Monthly Expense</h3>
  <canvas id="monthChart"></canvas>
</div>

<div class="card">
  <h3>üìÖ Day-wise Expense</h3>
  <select id="monthSelect"></select>
  <canvas id="dayChart"></canvas>
</div>

<!-- TABLE -->
<div class="card">
  <h3>üßæ Expense History</h3>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Description</th>
        <th>‚Çπ</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="expenseTable"></tbody>
  </table>
</div>

<!-- DELETE MODAL -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3>Delete Expense?</h3>
    <div class="modal-details">
      <p><b>Date:</b> <span id="delDate"></span></p>
      <p><b>Description:</b> <span id="delDesc"></span></p>
      <p><b>Amount:</b> ‚Çπ<span id="delAmount"></span></p>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn-danger" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
const API = "http://localhost:4000";
let expenses = [];
let deleteId = null;
let monthChart, dayChart;

/* ADD */
async function addExpense() {
  const d = new Date(dateInput.value);
  await fetch(API + "/expense", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      date: d,
      month: d.toLocaleString("default", { month: "long" }),
      day: d.getDate(),
      amount: Number(amountInput.value),
      description: descInput.value
    })
  });
  loadExpenses();
}

/* LOAD */
async function loadExpenses() {
  const res = await fetch(API + "/expenses");
  expenses = await res.json();
  renderMetrics();
  renderMonthChart();
  populateMonthDropdown();
  renderDayChart();
  renderTable();
}

/* METRICS */
function renderMetrics() {
  const today = new Date().toDateString();
  const currentMonth = new Date().toLocaleString("default", { month: "long" });

  let total = 0, todayTotal = 0, monthTotal = 0;

  expenses.forEach(e => {
    total += e.amount;
    if (new Date(e.date).toDateString() === today) todayTotal += e.amount;
    if (e.month === currentMonth) monthTotal += e.amount;
  });

  totalText.innerText = "‚Çπ" + total;
  todayText.innerText = "‚Çπ" + todayTotal;
  monthText.innerText = "‚Çπ" + monthTotal;
}

/* MONTH CHART */
function renderMonthChart() {
  const data = {};

  expenses.forEach(e => {
    data[e.month] = (data[e.month] || 0) + e.amount;
  });

  if (monthChart) monthChart.destroy();

  monthChart = new Chart(document.getElementById("monthChart"), {
    type: "bar",
    data: {
      labels: Object.keys(data),
      datasets: [{
        label: "Monthly Expense (‚Çπ)", // ‚úÖ REQUIRED
        data: Object.values(data),
        backgroundColor: "#6366f1"
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });
}

/* DAY CHART */
function populateMonthDropdown() {
  monthSelect.innerHTML = "";

  const months = [...new Set(expenses.map(e => e.month))];

  months.forEach(m => {
    const o = document.createElement("option");
    o.value = m;
    o.innerText = m;
    monthSelect.appendChild(o);
  });

  if (months.length > 0) {
    monthSelect.value = months[0]; // ‚úÖ SELECT FIRST MONTH
  }
}

function renderDayChart() {
  const month = monthSelect.value;
  if (!month) return;

  const data = {};
  expenses
    .filter(e => e.month === month)
    .forEach(e => {
      data[e.day] = (data[e.day] || 0) + e.amount;
    });

  const sortedDays = Object.keys(data).sort((a, b) => a - b);

  if (dayChart) dayChart.destroy();

  dayChart = new Chart(document.getElementById("dayChart"), {
    type: "line",
    data: {
      labels: sortedDays,
      datasets: [{
        label: `Daily Expense ‚Äì ${month}`, // ‚úÖ REQUIRED
        data: sortedDays.map(d => data[d]),
        borderColor: "#16a34a",
        backgroundColor: "rgba(22,163,74,0.15)",
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });
}

/* TABLE */
function renderTable() {
  expenseTable.innerHTML = "";
  expenses.forEach(e => {
    expenseTable.innerHTML += `
      <tr>
        <td>${new Date(e.date).toLocaleDateString()}</td>
        <td>${e.description}</td>
        <td>‚Çπ${e.amount}</td>
        <td><button class="btn-danger" onclick="openModal('${e._id}')">‚ùå</button></td>
      </tr>`;
  });
}

/* MODAL */
function openModal(id) {
  const e = expenses.find(x => x._id === id);
  deleteId = id;
  delDate.innerText = new Date(e.date).toLocaleDateString();
  delDesc.innerText = e.description;
  delAmount.innerText = e.amount;
  confirmModal.style.display = "flex";
}

function closeModal() {
  confirmModal.style.display = "none";
}

async function confirmDelete() {
  await fetch(API + "/expense/" + deleteId, { method: "DELETE" });
  closeModal();
  loadExpenses();
}

monthSelect.onchange = renderDayChart;
loadExpenses();
</script>

</body>
</html>
