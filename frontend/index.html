<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Expense Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial;
  background: #f4f6f8;
  padding: 20px;
}

.card {
  background: white;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 8px;
}

input, button, select {
  padding: 10px;
  margin: 5px;
}

button { cursor: pointer; }

.metrics {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin-bottom: 20px;
}

.metric {
  background: #eef2ff;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #ddd;
  text-align: center;
}

#message {
  margin-top: 10px;
  padding: 10px;
  display: none;
  font-weight: bold;
}

.success { background: #dcfce7; color: #166534; }
.error { background: #fee2e2; color: #991b1b; }
.warning { background: #fef9c3; color: #854d0e; }
</style>
</head>

<body>

<h1>üí∞ Expense Tracker</h1>

<div class="card">
  <input id="dateInput" type="date" />
  <input id="amountInput" type="number" placeholder="Amount ‚Çπ" />
  <input id="descInput" placeholder="Description" />
  <button onclick="addExpense()">Add Expense</button>
  <div id="message"></div>
</div>

<div class="metrics">
  <div class="metric">
    <h4>Total Spent</h4>
    <p id="totalText">‚Çπ0</p>
  </div>
  <div class="metric">
    <h4>This Month</h4>
    <p id="monthText">‚Çπ0</p>
  </div>
  <div class="metric">
    <h4>Today</h4>
    <p id="todayText">‚Çπ0</p>
  </div>
</div>

<div class="card">
  <h3>üìä Monthly Expense</h3>
  <canvas id="monthChart"></canvas>
</div>

<div class="card">
  <h3>üìÖ Day-wise Expense</h3>
  <select id="monthSelect"></select>
  <canvas id="dayChart"></canvas>
</div>

<div class="card">
  <h3>üßæ Expense History</h3>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Description</th>
        <th>‚Çπ</th>
        <th>‚ùå</th>
      </tr>
    </thead>
    <tbody id="expenseTable"></tbody>
  </table>
</div>

<script>
const API = "http://localhost:4000";

let expenses = [];
let monthChart = null;
let dayChart = null;

/* MESSAGE */
function showMessage(text, type) {
  const msg = document.getElementById("message");
  msg.className = type;
  msg.innerText = text;
  msg.style.display = "block";
  setTimeout(() => msg.style.display = "none", 3000);
}

/* ADD EXPENSE */
async function addExpense() {
  const dateValue = document.getElementById("dateInput").value;
  const amountValue = Number(document.getElementById("amountInput").value);
  const description = document.getElementById("descInput").value.trim();

  if (!dateValue || !amountValue || !description) {
    showMessage("‚ö†Ô∏è Fill all fields", "warning");
    return;
  }

  const d = new Date(dateValue);

  await fetch(API + "/expense", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      date: d,
      month: d.toLocaleString("default", { month: "long" }),
      day: d.getDate(),
      amount: amountValue,
      description
    })
  });

  showMessage("‚úÖ Expense added", "success");
  document.getElementById("dateInput").value = "";
  document.getElementById("amountInput").value = "";
  document.getElementById("descInput").value = "";

  loadExpenses();
}

/* LOAD */
async function loadExpenses() {
  const res = await fetch(API + "/expenses");
  expenses = await res.json();

  renderMetrics();
  renderMonthChart();
  populateMonthDropdown();
  renderDayChart();
  renderTable();
}

/* METRICS */
function renderMetrics() {
  const todayStr = new Date().toDateString();
  const currentMonth = new Date().toLocaleString("default", { month: "long" });

  let total = 0;
  let todayTotal = 0;
  let monthTotal = 0;

  expenses.forEach(e => {
    total += e.amount;
    if (new Date(e.date).toDateString() === todayStr) todayTotal += e.amount;
    if (e.month === currentMonth) monthTotal += e.amount;
  });

  document.getElementById("totalText").innerText = "‚Çπ" + total;
  document.getElementById("todayText").innerText = "‚Çπ" + todayTotal;
  document.getElementById("monthText").innerText = "‚Çπ" + monthTotal;
}

/* MONTH CHART */
function renderMonthChart() {
  const data = {};
  expenses.forEach(e => data[e.month] = (data[e.month] || 0) + e.amount);

  if (monthChart) monthChart.destroy();

  monthChart = new Chart(document.getElementById("monthChart"), {
    type: "bar",
    data: {
      labels: Object.keys(data),
      datasets: [{
        label: "Monthly Expense (‚Çπ)",
        data: Object.values(data),
        backgroundColor: "#6366f1"
      }]
    }
  });
}

/* DAY CHART */
function populateMonthDropdown() {
  const select = document.getElementById("monthSelect");
  select.innerHTML = "";

  [...new Set(expenses.map(e => e.month))].forEach(m => {
    const o = document.createElement("option");
    o.value = m;
    o.innerText = m;
    select.appendChild(o);
  });

  select.onchange = renderDayChart;
}

function renderDayChart() {
  const month = document.getElementById("monthSelect").value;
  if (!month) return;

  const data = {};
  expenses.filter(e => e.month === month)
    .forEach(e => data[e.day] = (data[e.day] || 0) + e.amount);

  if (dayChart) dayChart.destroy();

  dayChart = new Chart(document.getElementById("dayChart"), {
    type: "line",
    data: {
      labels: Object.keys(data),
      datasets: [{
        label: "Day-wise Expense (‚Çπ)",
        data: Object.values(data),
        borderColor: "#16a34a",
        tension: 0.3
      }]
    }
  });
}

/* TABLE */
function renderTable() {
  const tbody = document.getElementById("expenseTable");
  tbody.innerHTML = "";

  expenses.forEach(e => {
    tbody.innerHTML += `
      <tr>
        <td>${new Date(e.date).toLocaleDateString()}</td>
        <td>${e.description}</td>
        <td>‚Çπ${e.amount}</td>
        <td><button onclick="deleteExpense('${e._id}')">‚ùå</button></td>
      </tr>`;
  });
}

/* DELETE */
async function deleteExpense(id) {
  await fetch(API + "/expense/" + id, { method: "DELETE" });
  loadExpenses();
}

loadExpenses();
</script>

</body>
</html>
