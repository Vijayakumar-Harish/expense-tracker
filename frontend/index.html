<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Expense Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --primary: #6366f1;
  --bg: #f1f5f9;
  --card: #ffffff;
  --danger: #dc2626;
  --success: #16a34a;
}

* { box-sizing: border-box; }

body {
  font-family: Inter, system-ui, sans-serif;
  background: var(--bg);
  padding: 24px;
}

h1 { margin-bottom: 24px; }

.card {
  background: var(--card);
  padding: 20px;
  border-radius: 14px;
  margin-bottom: 20px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}

input, select {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

button {
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  background: var(--primary);
  color: white;
  cursor: pointer;
}

.metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
}

.metric {
  background: linear-gradient(135deg, #eef2ff, #ffffff);
  padding: 16px;
  border-radius: 12px;
  text-align: center;
}

.metric p {
  font-size: 22px;
  font-weight: 600;
}

.progress {
  height: 10px;
  background: #e5e7eb;
  border-radius: 8px;
  overflow: hidden;
}

.progress div {
  height: 100%;
  background: var(--primary);
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 12px;
  border-bottom: 1px solid #e5e7eb;
  text-align: center;
}

tr:hover { background: #f8fafc; }

canvas { max-height: 280px; }

/* MODAL */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal {
  background: white;
  padding: 24px;
  border-radius: 14px;
  width: 340px;
}

.modal-details {
  background: #f8fafc;
  padding: 12px;
  border-radius: 8px;
  margin: 14px 0;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.btn-danger { background: var(--danger); }
.btn-secondary { background: #e5e7eb; color: #111; }
</style>
</head>

<body>

<h1>üí∞ Expense Tracker</h1>

<!-- ADD EXPENSE -->
<div class="card">
  <input id="dateInput" type="date" />
  <input id="amountInput" type="number" placeholder="Amount ‚Çπ" />
  <input id="descInput" placeholder="Description" />
  <button onclick="addExpense()">Add Expense</button>
</div>

<!-- BUDGET -->
<div class="card">
  <h3>üéØ Monthly Budget</h3>
  <input id="budgetInput" type="number" placeholder="Set monthly budget ‚Çπ" />
  <button onclick="saveBudget()">Save</button>
  <p id="budgetError" style="color:#dc2626; font-size:14px; display:none;"></p>

  <p id="budgetText"></p>
  <div class="progress"><div id="budgetBar"></div></div>
</div>

<!-- METRICS -->
<div class="metrics">
  <div class="metric"><h4>Total</h4><p id="totalText">‚Çπ0</p></div>
  <div class="metric"><h4>This Month</h4><p id="monthText">‚Çπ0</p></div>
  <div class="metric"><h4>Avg / Day</h4><p id="avgDayText">‚Çπ0</p></div>
  <div class="metric"><h4>Highest Day</h4><p id="highestDayText">‚Çπ0</p></div>
</div>

<!-- CHARTS -->
<div class="card">
  <h3>üìä Monthly Expense</h3>
  <canvas id="monthChart"></canvas>
</div>

<div class="card">
  <h3>üìÖ Day-wise Expense</h3>
  <select id="monthSelect"></select>
  <canvas id="dayChart"></canvas>
</div>

<!-- EXPORT -->
<div class="card">
  <button onclick="exportCSV()">‚¨áÔ∏è Export CSV</button>
</div>
<!-- FILTER BAR -->
<div class="card">
  <h3>üîç Filter Expenses</h3>
  <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px;">
    <input type="date" id="fromDate" />
    <input type="date" id="toDate" />
    <input type="number" id="minAmount" placeholder="Min ‚Çπ" />
    <input type="number" id="maxAmount" placeholder="Max ‚Çπ" />
    <input type="text" id="searchText" placeholder="Search description" />
    <button onclick="clearFilters()">Clear</button>
  </div>
</div>
<!-- TABLE -->
<div class="card">
  <h3>üßæ Expense History</h3>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Description</th>
        <th>‚Çπ</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="expenseTable"></tbody>
  </table>
</div>

<!-- DELETE MODAL -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3>Delete Expense?</h3>
    <div class="modal-details">
      <p><b>Date:</b> <span id="delDate"></span></p>
      <p><b>Description:</b> <span id="delDesc"></span></p>
      <p><b>Amount:</b> ‚Çπ<span id="delAmount"></span></p>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn-danger" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
const API = "http://localhost:4000";
let expenses = [];
let deleteId = null;
let monthChart = null;
let dayChart = null;

/* ADD */
async function addExpense() {
  if (!dateInput.value || !amountInput.value || !descInput.value) return;
  const d = new Date(dateInput.value);

  await fetch(API + "/expense", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      date: d,
      month: d.toLocaleString("default", { month: "long" }),
      day: d.getDate(),
      amount: Number(amountInput.value),
      description: descInput.value
    })
  });

  dateInput.value = amountInput.value = descInput.value = "";
  loadExpenses();
}

/* LOAD */
async function loadExpenses() {
  const res = await fetch(API + "/expenses");
  expenses = await res.json();
  renderMetrics();
  renderMonthChart();
  populateMonthDropdown();
  renderDayChart();
  renderTable();
  renderBudget();
}

/* METRICS */
function renderMetrics() {
  let total = 0, monthTotal = 0;
  let dayMap = {};
  const currentMonth = new Date().toLocaleString("default", { month: "long" });

  expenses.forEach(e => {
    total += e.amount;
    if (e.month === currentMonth) monthTotal += e.amount;
    dayMap[e.day] = (dayMap[e.day] || 0) + e.amount;
  });

  const dayValues = Object.values(dayMap);
  totalText.innerText = "‚Çπ" + total;
  monthText.innerText = "‚Çπ" + monthTotal;
  avgDayText.innerText = "‚Çπ" + (dayValues.length ? Math.round(monthTotal / dayValues.length) : 0);
  highestDayText.innerText = "‚Çπ" + (dayValues.length ? Math.max(...dayValues) : 0);
}

/* MONTH CHART */
function renderMonthChart() {
  if (monthChart) monthChart.destroy();

  const data = {};

  expenses.forEach(e => {
    const d = new Date(e.date);
    const month = d.toLocaleString("default", { month: "long" });

    data[month] = (data[month] || 0) + e.amount;
  });

  const labels = Object.keys(data);
  if (!labels.length) return;

  monthChart = new Chart(document.getElementById("monthChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Monthly Expense (‚Çπ)",
        data: labels.map(l => data[l]),
        backgroundColor: "#6366f1"
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });
}

/* DAY CHART */
function populateMonthDropdown() {
  monthSelect.innerHTML = "";
  [...new Set(expenses.map(e => e.month))].forEach(m => {
    monthSelect.innerHTML += `<option>${m}</option>`;
  });
}

function renderDayChart() {
  if (dayChart) dayChart.destroy();

  const selectedMonth = monthSelect.value;
  if (!selectedMonth) return;

  const data = {};

  expenses.forEach(e => {
    const d = new Date(e.date);
    const month = d.toLocaleString("default", { month: "long" });
    const day = d.getDate();

    if (month === selectedMonth) {
      data[day] = (data[day] || 0) + e.amount;
    }
  });

  const labels = Object.keys(data).sort((a, b) => a - b);
  if (!labels.length) return;

  dayChart = new Chart(document.getElementById("dayChart"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: `Daily Expense ‚Äì ${selectedMonth}`,
        data: labels.map(l => data[l]),
        borderColor: "#16a34a",
        backgroundColor: "rgba(22,163,74,0.15)",
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });
}

/* TABLE */
function renderTable() {
  const fromDate = document.getElementById("fromDate").value;
  const toDate = document.getElementById("toDate").value;
  const minAmount = Number(document.getElementById("minAmount").value);
  const maxAmount = Number(document.getElementById("maxAmount").value);
  const search = document.getElementById("searchText").value.toLowerCase();

  const filtered = expenses.filter(e => {
    const d = new Date(e.date);

    if (fromDate && d < new Date(fromDate)) return false;
    if (toDate && d > new Date(toDate)) return false;
    if (minAmount && e.amount < minAmount) return false;
    if (maxAmount && e.amount > maxAmount) return false;
    if (search && !e.description.toLowerCase().includes(search)) return false;

    return true;
  });

  if (!filtered.length) {
    expenseTable.innerHTML = `<tr><td colspan="4">No expenses found</td></tr>`;
    return;
  }

  expenseTable.innerHTML = filtered.map(e => `
    <tr>
      <td>${new Date(e.date).toLocaleDateString()}</td>
      <td>${e.description}</td>
      <td>‚Çπ${e.amount}</td>
      <td>
        <button class="btn-danger" onclick="openModal('${e._id}')">‚ùå</button>
      </td>
    </tr>
  `).join("");
}

/* DELETE MODAL */
function openModal(id) {
  const e = expenses.find(x => x._id === id);
  deleteId = id;
  delDate.innerText = new Date(e.date).toLocaleDateString();
  delDesc.innerText = e.description;
  delAmount.innerText = e.amount;
  confirmModal.style.display = "flex";
}

function closeModal() {
  confirmModal.style.display = "none";
}

async function confirmDelete() {
  await fetch(API + "/expense/" + deleteId, { method: "DELETE" });
  closeModal();
  loadExpenses();
}

/* BUDGET */
function saveBudget() {
  const budget = Number(budgetInput.value);
  const spent = Number(monthText.innerText.replace("‚Çπ", ""));

  // Reset error state
  budgetError.style.display = "none";
  budgetError.innerText = "";

  if (!budget || budget <= 0) {
    budgetError.innerText = "Please enter a valid budget amount.";
    budgetError.style.display = "block";
    return;
  }

  if (budget < spent) {
    budgetError.innerText =
      `Budget ‚Çπ${budget} is less than already spent ‚Çπ${spent}. Increase your budget.`;
    budgetError.style.display = "block";
    return;
  }

  // ‚úÖ Save only if valid
  localStorage.setItem("budget", budget);

  // ‚úÖ Clear input after success
  budgetInput.value = "";

  renderBudget();
}


function renderBudget() {
  const budget = Number(localStorage.getItem("budget"));
  if (!budget) return;

  const spent = Number(monthText.innerText.replace("‚Çπ",""));
  budgetText.innerText = `‚Çπ${spent} / ‚Çπ${budget}`;
  budgetBar.style.width = Math.min(100, (spent / budget) * 100) + "%";
}

/* EXPORT */
function exportCSV() {
  let csv = "Date,Description,Amount\n";
  expenses.forEach(e =>
    csv += `${new Date(e.date).toLocaleDateString()},${e.description},${e.amount}\n`
  );
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv]));
  a.download = "expenses.csv";
  a.click();
}
function clearFilters() {
  fromDate.value = "";
  toDate.value = "";
  minAmount.value = "";
  maxAmount.value = "";
  searchText.value = "";
  renderTable();
}
monthSelect.onchange = renderDayChart;
loadExpenses();
["fromDate", "toDate", "minAmount", "maxAmount", "searchText"]
  .forEach(id => {
    document.getElementById(id).addEventListener("input", renderTable);
  });
  budgetInput.addEventListener("input", () => {
  budgetError.style.display = "none";
});
</script>

</body>
</html>
